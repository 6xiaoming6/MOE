import torch
import torch.nn.functional as F

batch_size, num_classes = 2, 2

x = torch.tensor([
    [
        [1, 2],
        [3, 4]
    ],
    [
        [5, 6],
        [7, 8]
    ]
])

mask = torch.tensor([
    [
        [0, 0],
        [0, 1]
    ]
])

print(x.shape)
print(mask.shape)

mask_flat = mask.view(-1).long()
category_counts = torch.bincount(mask_flat, minlength=num_classes)
print("每个类别的数量：", category_counts)
projection_mask_matrix = F.one_hot(mask_flat, num_classes=num_classes).float()
#class_counts = projection_mask_matrix.sum(dim=0)
# class_counts = torch.clamp(class_counts, min=1e-6)
# projection_mask_matrix /= class_counts.unsqueeze(0)
# gt_flat = self.data_32_gt[index]
# gt = torch.matmul(gt_flat, projection_mask_matrix)

x_flat = x.view(batch_size, -1).float()

x_aggregated = torch.matmul(x_flat, projection_mask_matrix)
print(x_aggregated)


sup32_flat = torch.tensor([[ 0.3814, -5.1100,  6.0526,  1.0407,  4.1244,  1.9567,  0.1151,  1.0653,
          1.9459, -0.3948,  4.7896,  2.0525,  4.5012, -2.2779,  0.1222,  0.7240,
          0.4322,  6.0519,  0.2879,  0.5018,  3.0588,  3.2034,  1.8975,  1.1370,
          0.2959,  0.3280,  1.5807,  0.0345, -0.2404,  0.0351,  0.1693,  0.0834,
          0.2933,  0.2552,  0.3182,  0.4278,  0.1304, -0.1812,  1.8904, -1.9527,
          0.1389,  0.0645,  0.0905, -0.1092, -0.0982, -0.2051,  1.0599, -0.4724,
          0.3780,  0.3873, -0.0085,  0.0984,  0.0382,  0.0349, -0.0163,  2.2474,
          0.2974, -0.2653,  0.1214,  0.3962, -0.0159,  0.3402,  0.0419, -0.1852,
          0.2576,  0.0426, -0.1584,  2.9622,  0.1426,  0.0537,  0.1097, -0.1405,
          0.2204,  0.3305,  0.0351,  0.0438,  0.1143, -1.0831,  0.0114,  0.0660,
         -0.1495,  0.1638,  0.1140,  0.2536,  0.1968,  1.8111, -0.0144, -0.2208,
          0.0731,  0.2534,  0.3443,  0.4253,  0.4046,  0.2519,  0.3271,  0.2180,
         -0.0682,  1.2079, -0.0904,  0.0959,  0.0156, -0.1611, -0.0112,  0.2119,
          0.1864,  0.1329,  0.1023, -0.0111, -3.3842,  0.0939,  0.1711, -0.2155,
          0.3281, -0.0414,  0.0548, -0.0883, -0.0892,  0.1385, -0.6973, -0.0251,
          0.0941,  0.0575, -0.1431, -0.4102,  0.3920,  0.1993, -0.5777, -1.4258,
          3.1127,  0.2004, -0.0487,  0.3034, -0.1860, -0.0960, -0.1736, -0.2994,
         -0.0750, -0.5104,  0.0780,  0.2165, -0.0462,  1.0813,  2.1878, -0.3355,
         -0.5193,  0.3920,  0.0801, -2.4110, -0.5389,  0.8885, -0.9596, -0.0716,
          0.1186, -0.6794,  0.3247,  0.5262,  0.1824,  0.1466, -0.3419, -0.3300,
         -0.7293, -0.2429]])

sup32_gt_flat = torch.tensor([[ -5.9529, -52.3569, -80.2627,  -4.9216, -10.8353,  -3.9451,  -4.9137,
          -3.9373, -18.7176,  -8.8353, -24.5059, -54.8549, -50.3216, -61.2510,
         -10.5686, -23.6627,  -8.7490, -50.9255, -10.7882,  -6.8588, -28.7176,
         -27.0118,  -7.6392,  -3.8275,  -1.9216,  -1.9529,  -9.8510,  -0.9529,
          -0.9529,  -0.9686,  -0.9686,  -1.9373,  -3.9137,  -5.5843,  -0.9608,
          -0.9608,  -0.9608,  -0.9686,  -7.7333, -39.2000,  -0.9608,  -0.9608,
          -0.9686,  -0.9686,  -0.9686,  -0.9765, -10.7098,  -8.7882,  -0.9686,
          -0.9686,  -0.9765,  -0.9765,  -0.9686,  -0.9686,  -0.9765, -36.0314,
          -0.9765,  -0.9765,  -0.9765,  -0.9843,  -0.9765,  -0.9686,  -0.9686,
          -0.9686,  -0.9686,  -0.9608, -11.6157, -33.6196,  -1.9373,  -0.9765,
          -0.9843,  -0.9843,  -0.9843,  -0.9843,  -0.9686,  -0.9686,  -0.9686,
         -10.7412,  -0.9765,  -0.9843,  -0.9843,  -0.9843,  -0.9765,  -0.9686,
          -0.9686, -14.3804,  -0.9686,  -0.9686,  -0.9765,  -0.9765,  -0.9765,
          -0.9843,  -0.9686,  -0.9686,  -0.9686,  -0.9608,  -0.9765, -17.5137,
          -7.6784,  -0.9686,  -0.9686,  -0.9686,  -0.9686,  -0.9608,  -0.9608,
          -0.9608,  -0.9686,  -0.9686, -16.6392,  -4.8588,  -0.9686,  -0.9686,
          -0.9686,  -0.9608,  -0.9529,  -0.9529,  -0.9451,  -0.9529,  -1.9216,
          -0.9686,  -0.9608,  -0.9529,  -0.9529,  -0.9451,  -0.9451,  -0.9451,
          -1.8902, -27.2196,  -8.6157,  -8.6549,  -0.9608,  -0.9529,  -0.9451,
          -0.9373,  -0.9373,  -0.9373,  -0.9529,  -0.9451,  -0.9373,  -0.9451,
          -2.8039,  -5.8353, -15.4039,  -4.7255,  -0.9373,  -0.9294,  -0.9294,
          -2.8745,  -0.9451,  -0.9373,  -0.9294,  -0.9294,  -0.9294,  -1.8431,
          -0.9216,  -0.9216,  -0.9216,  -0.9294,  -0.9451,  -0.9373,  -0.9451,
          -0.9451]])

moe_output = torch.tensor([[-0.0083, -0.0531, -0.0325,  0.0062, -0.0033,  0.0077,  0.0150,  0.0073,
         -0.0130, -0.0081, -0.0162,  0.0006, -0.0100, -0.0373, -0.0080,  0.0048,
         -0.0235, -0.0153,  0.0293, -0.0054, -0.0349, -0.0251, -0.0002, -0.0312,
         -0.0261, -0.0042,  0.0100, -0.0117, -0.0231,  0.0148, -0.0092, -0.0235,
         -0.0098, -0.0019,  0.0037, -0.0149,  0.0075, -0.0176, -0.0109,  0.0149,
         -0.0109,  0.0050,  0.0030, -0.0453, -0.0101,  0.0026,  0.0040, -0.0007,
          0.0134, -0.0278,  0.0309, -0.0152,  0.0371, -0.0273, -0.0242, -0.0231,
         -0.0099,  0.0095, -0.0025, -0.0163,  0.0159, -0.0117, -0.0073, -0.0273,
         -0.0387, -0.0076, -0.0036, -0.0258, -0.0118, -0.0060,  0.0145,  0.0016,
          0.0175,  0.0093, -0.0317,  0.0108, -0.0194,  0.0051,  0.0083, -0.0118,
         -0.0037, -0.0028,  0.0205, -0.0201,  0.0138, -0.0235, -0.0033,  0.0015,
         -0.0192,  0.0019, -0.0445, -0.0100, -0.0369, -0.0135,  0.0258, -0.0209,
         -0.0006, -0.0338,  0.0020,  0.0149,  0.0025, -0.0260,  0.0131,  0.0096,
          0.0018, -0.0019,  0.0234,  0.0166,  0.0184, -0.0165,  0.0026,  0.0268,
         -0.0239, -0.0395, -0.0371,  0.0058,  0.0157, -0.0150, -0.0263,  0.0298,
          0.0169,  0.0255,  0.0034, -0.0116, -0.0035, -0.0026,  0.0352,  0.0199,
          0.0034, -0.0014,  0.0028, -0.0107, -0.0169, -0.0225,  0.0107, -0.0064,
         -0.0509,  0.0336,  0.0079, -0.0034, -0.0305,  0.0171, -0.0224,  0.0190,
         -0.0114, -0.0182, -0.0303,  0.0053,  0.0151, -0.0081, -0.0216, -0.0195,
         -0.0263, -0.0429, -0.0337,  0.0122, -0.0088, -0.0066,  0.0053, -0.0087,
          0.0097, -0.0303]])

moe_loss = F.mse_loss(moe_output, sup32_gt_flat)
moe_loss = torch.nn.MSELoss()(moe_output, sup32_gt_flat)
print("MOE Loss:", moe_loss.item())
sup32_loss = F.mse_loss(sup32_flat, sup32_gt_flat)
sup32_loss = torch.nn.MSELoss()(sup32_flat, sup32_gt_flat)
print("Sup32 Loss:", sup32_loss.item())



import numpy as np
import torch
import torch.nn as nn

# 创建相同数据
np.random.seed(42)
torch.manual_seed(42)

# NumPy数组
a_np = np.random.randn(10, 5)
b_np = np.random.randn(10, 5)

# PyTorch张量
a_torch = torch.tensor(a_np, dtype=torch.float32)
b_torch = torch.tensor(b_np, dtype=torch.float32)

# 计算MSE
mse_np = np.mean(np.square(a_np - b_np))
mse_torch = nn.MSELoss()(a_torch, b_torch)

print(f"NumPy MSE: {mse_np:.6f}")
print(f"PyTorch MSE: {mse_torch.item():.6f}")
print(f"是否相等: {np.isclose(mse_np, mse_torch.item(), rtol=1e-6)}")
# 输出: True (在浮点误差范围内)